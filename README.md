# EcoWatt ESP-IDF Project

This project implements an EcoWatt device using ESP-IDF for data acquisition, compression, and over-the-air (OTA) firmware updates (FOTA).

## Prerequisites

- ESP-IDF v5.4.2 installed and configured.
- Python 3.x for the server.
- PowerShell (for Windows) or equivalent shell for firmware preparation.

## Configuration

Before building, ensure the following settings in `sdkconfig`:

1. Run `idf.py menuconfig`.
2. Navigate to **Serial flasher config** > **Flash size** and set to **4MB**.
3. Navigate to **Bootloader config** > **Bootloader manager** and enable **Enable app rollback support**.
4. Navigate to **Partition Table** and set to **Factory app, two OTA definitions**.
5. Save and exit.

Alternatively, the `sdkconfig` file is already configured with these settings:
- `CONFIG_ESPTOOLPY_FLASHSIZE="4MB"`
- `CONFIG_BOOTLOADER_APP_ROLLBACK_ENABLE=y`
- `CONFIG_PARTITION_TABLE_TWO_OTA=y`

## Building and Flashing

1. Build the project:
   ```
   idf.py build
   ```

2. Flash the firmware to the ESP32:
   ```
   idf.py flash
   ```

   The ESP-IDF output will display build and flash progress, including partition information and flash operations.

## Running the Server

The server (`server/app.py`) handles data uploads from devices and serves FOTA updates.

1. Navigate to the `server` directory:
   ```
   cd server
   ```

2. Install dependencies (if not already done):
   ```
   pip install -r requirements.txt
   ```

3. Prepare the firmware binary for FOTA by running the following commands in PowerShell (one-time setup) in server folder:

   ```powershell
   Remove-Item .\logs -Recurse -Force -ErrorAction SilentlyContinue
   New-Item -ItemType Directory .\logs | Out-Null

   $logs  = "$PWD\logs"
   $bin   = "..\build\ecowatt.bin"  
   $chunk = 8192
   $ver   = "1.0.4"   # bump version to force a fresh session
   $bytes = [IO.File]::ReadAllBytes($bin)
   $size  = $bytes.Length
   $hash  = (Get-FileHash -Algorithm SHA256 $bin).Hash.ToLower()

   # write manifest WITHOUT BOM
   $mf = ('{{"version":"{0}","size":{1},"hash":"{2}","chunk_size":{3}}}' -f $ver,$size,$hash,$chunk)
   Set-Content -Path (Join-Path $logs "fota_manifest.json") -Value $mf -Encoding Ascii -NoNewline

   # split to 0000, 0001, ...
   $i=0
   for ($off=0; $off -lt $size; $off += $chunk) {
     $len=[Math]::Min($chunk,$size-$off)
     $b64=[Convert]::ToBase64String($bytes,$off,$len)
     Set-Content -Path (Join-Path $logs ("fota_chunk_{0:D4}.b64" -f $i)) -Value $b64 -Encoding ASCII -NoNewline
     $i++
   }
   "Created $i chunks for size $size (hash=$hash) at $logs"
   $env:LOG_DIR = "$PWD\logs"
   python .\app.py
   ```

   This script:
   - Cleans and creates the `logs` directory.
   - Reads the built `ecowatt.bin` from the `build` directory.
   - Generates a FOTA manifest JSON file.
   - Splits the binary into base64-encoded chunks.
   - Starts the Flask server with the log directory set.

4. The server will run on `http://localhost:5000` (or the configured port).

## Usage

- The ESP32 device will connect to Wi-Fi, acquire data, compress it, and upload to the server.
- FOTA updates can be triggered by placing the manifest and chunks in the server's `logs` directory.
- Access the admin dashboard at `http://localhost:5000/admin` to view uploads and FOTA progress.

## Project Structure

```
EcoWatt/
├── .clangd                 # Clangd configuration for C++ language server
├── CMakeLists.txt          # ESP-IDF project root CMake file
├── README.md               # This file
├── sdkconfig               # ESP-IDF configuration file
├── sdkconfig.old           # Backup of previous SDK config
├── .vscode/                # VSCode workspace settings
├── build/                  # Build artifacts (generated by idf.py build)
├── logs/                   # Log files (generated)
├── main/                   # ESP-IDF application source code
│   ├── acquisition.cpp/.hpp  # Data acquisition from sensors
│   ├── buffer.cpp/.hpp       # Data buffering
│   ├── codec.cpp/.hpp        # Data compression codec
│   ├── control.cpp/.hpp      # Runtime control and commands
│   ├── fota.cpp/.hpp         # Firmware over-the-air update logic
│   ├── main.cpp              # Application entry point
│   ├── modbus.cpp/.hpp       # Modbus communication
│   ├── nvstore.cpp/.hpp      # Non-volatile storage
│   ├── packetizer.cpp/.hpp   # Data packetization
│   ├── security.cpp/.hpp     # HMAC security envelope
│   ├── transport_idf.cpp/.hpp # ESP-IDF transport layer
│   ├── CMakeLists.txt        # Main component CMake file
│   └── Kconfig               # Kconfig menu for main component
├── server/                 # Python Flask server
│   ├── app.py               # Flask application
│   ├── requirements.txt     # Python dependencies
│   ├── ecowatt.db           # SQLite database (generated)
│   ├── demo_firmware.bin    # Demo firmware binary
│   ├── .venv/               # Virtual environment (generated)
│   └── logs/                # Server logs and FOTA files (generated)
└── test/                   # Test scripts
    ├── 10_queue_config.sh   # Config queuing test
    ├── 20_queue_command.sh  # Command queuing test
    ├── 30_security_bad_mac.py # Security test (bad MAC)
    ├── 31_security_good_mac.py # Security test (good MAC)
    └── 40_fota_pack.py      # FOTA packaging test
```

## Notes

- Ensure the binary path in the PowerShell script matches your build output.
- Update the version in the script for new firmware releases.
- The server uses SQLite for data storage (`ecowatt.db`).
